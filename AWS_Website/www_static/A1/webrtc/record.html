<html>
<head>
<script src="/A1/js/RTCMultiConnection.js"></script>
<script src="/A1/js/RecordRTC.js"></script>
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
audio {
	display: none;
}
video {
	display: block;
    width: 90%;
}
</style>
<script>

var recordStarted = 0;

$( document ).ready(function() {
	var socket = io.connect(document.location.hostname + ':' + location.port);
	var MODERATOR_CHANNEL_ID = 'slite-recording'; // channel-id
	var MODERATOR_SESSION_ID = '<%= hash %>-recording';    // room-id
	var MODERATOR_ID         = '<%= userId%>';    // user-id
	var MODERATOR_SESSION    = {         // media-type
		screen: true,
		audio: true
	};
	var MODERATOR_EXTRA      = {};       // empty extra-data

	var moderator     = new RTCMultiConnection(MODERATOR_CHANNEL_ID);

	moderator.autoCloseEntireSession = true;
	moderator.session = MODERATOR_SESSION;
	moderator.userid  = MODERATOR_ID;
	moderator.extra   = MODERATOR_EXTRA;
	
	moderator.onstream = function(event) {
		if(event.type=="local") {
			startBlinking();
			recordStarted = 1;
			$('#recording', window.parent.document).animate({ "width": "60px", "clear": "both" },300);
			$("#stopRecording").prop('disabled', false);
		}
		if(event.isScreen) {
			moderator.streams[event.streamid].startRecording({
				video: true
			});
			$( "#screensharing" ).append(event.mediaElement);
		}
		if (event.isAudio) {
			moderator.streams[event.streamid].startRecording({
				audio: true
			});
			$( "#audiosharing" ).append(event.mediaElement);
		}
	};

	//function appendSession(media, streamid, event) {
	$('#stopRecording').click( function () {
		recordStarted = 0;
	
		var videoStream = moderator.streams.selectFirst({
			isScreen: true,
			local: true
		});	
		
		var audioStream = moderator.streams.selectFirst({
			isAudio: true,
			local: true
		});	

		moderator.streams[videoStream.streamid].stopRecording(function(blob) {
			if(blob.video) {
				h2 = document.createElement('p');
				h2.innerHTML = '<a href="' + URL.createObjectURL(blob.video) + '" target="_blank">Open recorded ' + blob.video.type + '</a>';
				$( "#video_result" ).append(h2);
				console.log(blob);
			}
		});
		
		moderator.streams[audioStream.streamid].stopRecording(function(blob) {
			console.log(blob);
			if(blob.audio) {
				h2 = document.createElement('p');
				h2.innerHTML = '<a href="' + URL.createObjectURL(blob.audio) + '" target="_blank">Open recorded ' + blob.audio.type + '</a>';
				$( "#audio_result" ).append(h2);
			}
		});
		
		moderator.streams.stop();	
		stopSession();

		$("#stopRecording").prop('disabled', true);
		$("#startRecording").prop('disabled', false);
	});
	//}
	
	function startSession() {
		moderator.open({
			dontTransmit: true,
			sessionid:    MODERATOR_SESSION_ID
		});
	}
	
	function stopSession() {
		moderator.close();
	}
	
	var getChromeExtensionStatus = function (callback) {
		if (!!navigator.mozGetUserMedia) return callback('not-chrome');

		var extensionid = 'ajhifddimkapgcifgcodmmfdlknahffk';

		var image = document.createElement('img');
		image.src = 'chrome-extension://' + extensionid + '/icon.png';
		image.onload = function () {
			callback('installed-enabled');
		};
		image.onerror = function () {
			callback('not-installed');
		};
	}

	getChromeExtensionStatus(function(result) {
		if(result == 'not-installed') {
			$('#install_chrome_extension').show();
		}
		else if(result == 'installed-enabled') {
			$("#startRecording").prop('disabled', false);
		}
		else {
			if(navigator.userAgent.indexOf("Firefox") != -1 )  {
				moderator.onMediaError = function(error) {
					if(error.name == 'PermissionDeniedError') {
						$("#install_firefox_extension").show();
					}
				};

				$("#startRecording").prop('disabled', false);
			}
			else {
				alert('We only support the latest versions of Google Chrome and FF');
			}
		}
	});
	
	$('#startRecording').click( function () {
		startSession();
		$("#startRecording").prop('disabled', true);
		//$("#audio_result").empty();
		//$("#video_result").empty();
	});
});

function startBlinking() {
	$("#mainBody").hide();
	$("#recStarted").show();	
}

function stopBlinking() {
	$("#mainBody").show();	
	$("#recStarted").hide();
}

</script>
</head>
<body onload="">

<div id="recStarted" style="position: absolute;  top: 40px; display: none">
<img src="/img/matrox-record-icon.jpg" width="50" height="60">
</div>

<div id="mainBody">

<button id="startRecording" disabled>Start recording</button>
<button id="stopRecording" disabled>Stop recording</button>

<br>

<div id="audio_result"></div>
<div id="video_result"></div>

<div id="screensharing"></div>
<div id="audiosharing"></div>

<ul>
	<li id="install_chrome_extension" style="display: none">
		<a href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk" target="_blank">Click <b>here</b> to install Chrome Presenter Extension (audience don't need it)</a>
	</li>

	<li id="install_firefox_extension" style="display: none">
		<a href="https://addons.mozilla.org/en-US/firefox/addon/enable-screen-capturing/" target="_blank">Click here to install Firefox Presenter Extension (audience don't need it)</a>
	</li>
</ul>

</body>


</body>
</html>
