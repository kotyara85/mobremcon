<html>
<head>
<script src="/A1/js/RTCMultiConnection.js"></script>
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
audio {
	display: none;
}
video {
	display: block;
    width: 90%;
}
</style>
<script>
// DUPLICATE SOCKET
var socket = io.connect(document.location.hostname + ':' + location.port);
var MODERATOR_CHANNEL_ID = 'slite-screen'; // channel-id
var MODERATOR_SESSION_ID = '<%= hash %>-screen';    // room-id
var MODERATOR_ID         = '<%= userId%>';    // user-id
var MODERATOR_SESSION    = {         // media-type
	audio: true,
	screen: true
};
var MODERATOR_EXTRA      = {};       // empty extra-data

var moderator     = new RTCMultiConnection(MODERATOR_CHANNEL_ID);
moderator.autoCloseEntireSession = true;
moderator.session = MODERATOR_SESSION;
moderator.userid  = MODERATOR_ID;
moderator.extra   = MODERATOR_EXTRA;

moderator.onstream = function(event) {
	if(event.isScreen) {
		socket.emit("presenterScreensharing", {open: 1, hash: '<%= hash %>'});
		$( "#screensharing" ).append(event.mediaElement);

		if(navigator.userAgent.indexOf("Firefox") != -1 )  {

		}
	}

	if (event.isAudio) {
		// Only for GC. 
		$( "#audiosharing" ).append(event.mediaElement);
	}
};

function startSession() {
	moderator.open({
		dontTransmit: true,
		sessionid:    MODERATOR_SESSION_ID
	});
}
function stopSession() {
	moderator.close();
}

</script>
</head>
<body onload="">
<div id="screensharing"></div>
<div id="audiosharing"></div>

<ul>
	<li id="install_chrome_extension" style="display: none">
		<a href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk" target="_blank">Click <b>here</b> to install Chrome Presenter Extension (audience don't need it)</a>
	</li>

	<li id="install_firefox_extension" style="display: none">
		<a href="https://addons.mozilla.org/en-US/firefox/addon/enable-screen-capturing/" target="_blank" id="firefox_plugin_button">Click here to install Firefox Presenter Extension (audience don't need it)</a>
	</li>
</ul>

<script>
var getChromeExtensionStatus = function (callback) {
	if (!!navigator.mozGetUserMedia) return callback('not-chrome');

	var extensionid = 'ajhifddimkapgcifgcodmmfdlknahffk';

	var image = document.createElement('img');
	image.src = 'chrome-extension://' + extensionid + '/icon.png';
	image.onload = function () {
		callback('installed-enabled');
	};
	image.onerror = function () {
		callback('not-installed');
	};
}

getChromeExtensionStatus(function(result) {
	if(result == 'not-installed') {
		$('#install_chrome_extension').show();
	}
	else if(result == 'installed-enabled') {
		startSession();
	}
	else {
		if(navigator.userAgent.indexOf("Firefox") != -1 )  {
			moderator.onMediaError = function(error) {
				console.log(error);
				if(error.name == 'PermissionDeniedError') {
					window.postMessage({
						enableScreenCapturing: true,
						domains: window.location.hostname
					}, "*");
					$("#install_firefox_extension").show();
				}
			};
			startSession();
		}
		else {
			alert("We only support the latest versions of Google Chrome and FireFox")
		}
	}
});

window.addEventListener("message", function(event) {
    var addonMessage = event.data;

    if(!addonMessage || typeof addonMessage.enabledScreenCapturing === 'undefined') return;

    if(addonMessage.enabledScreenCapturing === true) {
		location.reload();
    }
    else {
        // reason === 'user-rejected'
        alert(addonMessage.reason);
    }
}, false);


$('#firefox_plugin_button').click( function () {
	setTimeout(function(){ location.reload(); }, 10000);
});

</script>

</body>
</html>
