<html>
<head>
<script src="//cdn.webrtc-experiment.com/RTCMultiConnection.js"></script>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//cdn.webrtc-experiment.com/video-conferencing/conference.js"> </script>
<script src="/socket.io/socket.io.js"></script>
<style>
video {
	display: block;
    width: 90%;
}
</style>
<script>

var MODERATOR_CHANNEL_ID = 'slite-video'; // channel-id
var MODERATOR_SESSION_ID = '<%= hash %>-video';    // room-id
var MODERATOR_ID         = '<%= userId%>';    // user-id
var MODERATOR_SESSION    = {         // media-type
    audio: true,
    video: true,
};
var MODERATOR_EXTRA      = {};       // empty extra-data

if(typeof videoPresenterSocket !== 'undefined') {
	alert('videoPresenterSocket is already defined!');
}
var videoPresenterSocket = io.connect(document.location.hostname + ':' + location.port);
var moderator     = new RTCMultiConnection(MODERATOR_CHANNEL_ID);
moderator.autoCloseEntireSession = true;
moderator.session = MODERATOR_SESSION;
moderator.userid  = MODERATOR_ID;
moderator.extra   = MODERATOR_EXTRA;

moderator.onstream = function(event) {
	if(event.isVideo) {
		if(event.type == "local") {
			$( "#videosharing" ).append(event.mediaElement);
			videoPresenterSocket.emit("presenterVideoChat", {open: 1, hash: '<%= hash %>'});
		}
		else if(event.type == "remote") {
			$( "#videosharingR" ).append(event.mediaElement);
		}
	}
	if (event.isAudio) {
		$( "#audiosharing" ).append(event.mediaElement);
	}
};

function startSession() {
	moderator.open({
		dontTransmit: true,
		sessionid:    MODERATOR_SESSION_ID
	});
}
function stopSession() {
	moderator.close();
}
function switchVideoType() {
	var switchTo = ($("#type_switch").attr( "value" ) == 0) ? 1 : 0;
	if(switchTo == 1) {
		$("#type_switch").text("One way");
		moderator.addStream({video: true, audio: true})
	}
	else {
		$("#type_switch").text("Conference");
		moderator.removeStream({video: true, audio: true})
	}
	$("#type_switch").attr( "value", switchTo );

	videoPresenterSocket.emit("presenterVideoChat", {open: (switchTo == 1) ? 2 : 1, reload: (switchTo == 1) ? 2 : 1, hash: '<%= hash %>'});
}

</script>
</head>
<body onload="startSession()">
<button value="0" onclick="switchVideoType()" id="type_switch">Conference</button>
<div id="videosharing" style="position: absolute; width: 100px; right: 20px; border: 1px solid #3F7FBF;"></div>
<div id="videosharingR"></div>
<div id="audiosharing"></div>
</body>
</html>