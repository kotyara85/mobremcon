<html>
<head>
<script src="/A1/js/webrtc/RTCMultiConnection.js"></script>
<script src="/A1/js/webrtc/firebase.js"></script>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
video {
	display: block;
    width: 90%;
}
.videoL {
	position: absolute;
	width: 100px;
	right: 20px;
	border: 1px solid #3F7FBF;
	display: block;
}
</style>
<script>
// DUPLICATE SOCKET
var socketWebrtc = io.connect(document.location.hostname + ':' + location.port);
var participants = new RTCMultiConnection('slite-video');

socketWebrtc.on('sharing-client', function (data) {
	startSession(data.moderatorId, data.chatMode);
	function startSession(moderatorId, chatMode) {
		var MODERATOR_CHANNEL_ID = 'slite-video'; // channel-id
		var MODERATOR_SESSION_ID = '<%= hash %>-video';    // room-id
		var MODERATOR_ID         = '' + moderatorId + '';    // user-id
		var MODERATOR_SESSION = {};

		if(chatMode == 1) {
			MODERATOR_SESSION    = {
				oneway: true
			};
		}
		else if(chatMode == 2) {
			$( "#videosharing" ).addClass( "videoL" );
			MODERATOR_SESSION    = {
				video: true,
				audio: true
			};
		}

		participants.join(	{
				sessionid: MODERATOR_SESSION_ID,
				userid:    MODERATOR_ID,
				session:   MODERATOR_SESSION
			}
		);

		participants.onstream = function(event) {
			if(event.isVideo) {
				if(event.type == "local") {
					$( "#videosharing" ).append(event.mediaElement);
					if(navigator.userAgent.indexOf("Firefox") != -1 )  {
						$("#" + event.streamid).hide();
						setTimeout(function(){
							event.mediaElement.play();
							$("#" + event.streamid).show();
						}, 1000);
					}
				}
				else if(event.type == "remote") {
					$( "#videosharingR" ).append(event.mediaElement);
					if(navigator.userAgent.indexOf("Firefox") != -1 )  {
						$("#" + event.streamid).hide();
						setTimeout(function(){
							event.mediaElement.play();
							$("#" + event.streamid).show();
						}, 1000);
					}
				}
			}
			if (event.isAudio) {
				$( "#audiosharing" ).append(event.mediaElement);
			}
		};
	}

});

function start() {
	socketWebrtc.emit("sharing-server", {hash: '<%= hash %>'});
}

function addStream() {
	participants.removeStream({
		oneway: true
	});

	participants.addStream({
		video: true,
		audio: true
	});
}

function changeClass() {
	$( "#videosharing" ).addClass( "videoL" );
}

</script>
</head>
<body onload="start()">
<div id="videosharing"></div>
<div id="videosharingR"></div>
<div id="audiosharing" style="display: none"></div>
</body>
</html>
